
options:
  max-time: 5

pipelines:
  default:
    - parallel:
      - step:
          name: Build & Test 3.7
          image: python:3.7
          caches: &caches
            - pip
          script: &build_test
            - apt-get update
            - apt-get install -y build-essential libffi-dev libfuzzy-dev python3-dev
            - mkdir -p /etc/assemblyline/
            - mkdir -p /var/cache/assemblyline/
            - cp test/bitbucket/config.yml /etc/assemblyline
            - pip install --no-cache-dir -r test/requirements.txt
            - pip install --no-cache-dir -e .
            # - pytest -rsx -vv
      - step:
          name: Build & Test 3.8
          image: python:3.8
          caches: *caches
          script: *build_test
  tags:
    v*:
      - step:
          name: Build Package
          image: python:3.8
          script:
            - pip install --no-cache-dir wheel
            - python setup.py bdist_wheel
            - ls dist/
          artifacts:
            - dist/*
      - parallel:
        - step:
            name: Test 3.7
            image: python:3.7
            script: &deploy_test
              - rm -rf assemblyline_service_client setup.py  # Make sure we are running on the package from the prior build
              - apt-get update
              - apt-get install -y build-essential libffi-dev libfuzzy-dev python3-dev
              - pip install --no-cache-dir -f dist assemblyline-service-client
              - mkdir -p /etc/assemblyline/
              - mkdir -p /var/cache/assemblyline/
              - cp test/bitbucket/config.yml /etc/assemblyline
              - pip install --no-cache-dir -r test/requirements.txt
              #- pytest -rsx -vv
        - step:
            name: Test 3.8
            image: python:3.8
            script: *deploy_test
            caches: *caches
      - step:
          name: Deploy to Test PyPI
          image: python:3.8
          deployment: test_pypi
          script:
            - pip install --no-cache-dir twine
            - ls dist
            - twine upload --skip-existing --repository-url $TEST_REPOSITORY_URL dist/*
      - step:
          name: Deploy to PyPI
          image: python:3.8
          deployment: pypi
          script:
            - pip install --no-cache-dir twine
            - ls dist
            - twine upload --skip-existing dist/*
